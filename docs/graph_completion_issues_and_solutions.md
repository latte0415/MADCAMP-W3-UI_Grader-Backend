# 그래프 구축 종료 조건의 논리적 문제점과 해결책

## 문제점 분석

### 1. **동치 노드 문제: 같은 상태의 노드에서 반복 탐색**

**현재 상황:**
- `create_or_get_node`는 동치 노드(state_hash, a11y_hash, input_state_hash가 같은 노드)를 찾아 반환합니다.
- 하지만 각 노드에서 액션을 추출할 때는 **동치 노드들을 고려하지 않습니다**.
- 결과: 같은 상태의 노드가 여러 개 생성되면, 각 노드에서 같은 액션들을 계속 추출하고 시도합니다.

**예시:**
```
노드 A (state_hash: abc123) → 액션 1, 2, 3 추출
노드 B (state_hash: abc123) → 액션 1, 2, 3 추출 (동일!)
노드 C (state_hash: abc123) → 액션 1, 2, 3 추출 (동일!)
```

### 2. **완료 조건의 논리적 허점**

**문제점:**
- 최대 엣지 수(500개)에 도달하기 전에 이미 **모든 가능한 경로를 탐색**했을 수 있지만 감지하지 못함
- 같은 액션이 반복되어도 엣지 수는 증가하지만 실제로는 **새로운 탐색이 없는 경우**
- 실패한 액션들이 많아서 엣지 수가 적게 증가하는 경우

**예시 시나리오:**
```
상황: 작은 웹사이트 (노드 10개, 각 노드당 액션 5개)
- 가능한 최대 엣지 수: 50개
- 하지만 실패한 액션 재시도로 인해 엣지 수가 계속 증가
- 실제로는 50개 이상의 엣지가 생성되지만, 새로운 경로 탐색은 없음
```

### 3. **노드별 완료 상태 추적 부재**

**현재 문제:**
- 특정 노드에서 더 이상 처리할 액션이 없는지 추적하지 않음
- 모든 액션이 중복이거나 실패 제한에 도달했어도 계속 액션을 추출함

### 4. **같은 노드로 돌아오는 경우의 무한 루프 가능성**

**문제:**
- 액션이 실패하거나 같은 노드로 돌아오는 경우에도 계속 액션을 추출하고 워커를 생성
- 순환 경로에서 무한 루프 가능성

## 해결책 제안

### 해결책 1: 동치 노드 기반 액션 추출 제한

**아이디어:** 동치 노드들 중 하나에서 이미 액션을 추출했다면, 다른 동치 노드에서는 같은 액션을 추출하지 않음

**구현 방법:**
1. 노드 생성 시 동치 노드 그룹 식별
2. 액션 추출 전에 동치 노드 그룹에서 이미 시도한 액션 확인
3. 이미 시도한 액션은 스킵

**장점:**
- 불필요한 중복 탐색 방지
- 엣지 수 증가 속도 감소
- 실제 새로운 경로 탐색에 집중

**단점:**
- 동치 노드 그룹 조회 비용
- 구현 복잡도 증가

### 해결책 2: 노드별 완료 상태 추적

**아이디어:** 각 노드에서 더 이상 처리할 액션이 없을 때 "완료" 상태로 표시

**구현 방법:**
1. 노드 테이블에 `is_explored` 또는 `exploration_complete` 컬럼 추가
2. 노드에서 모든 액션을 시도했거나, 남은 액션이 모두 중복/실패 제한인 경우 완료 표시
3. 완료된 노드에서는 액션 추출 스킵

**완료 조건:**
- 모든 가능한 액션이 이미 성공한 엣지로 존재
- 남은 액션이 모두 실패 제한(3회)에 도달
- 동치 노드 그룹에서 모든 액션 시도 완료

**장점:**
- 명확한 완료 조건
- 불필요한 작업 방지
- 실제 탐색 완료 시점 감지 가능

**단점:**
- DB 스키마 변경 필요
- 노드 완료 상태 업데이트 로직 필요

### 해결책 3: 개선된 완료 조건 체크

**아이디어:** 엣지 수뿐만 아니라 실제 탐색 진행 상황을 고려한 완료 조건

**구현 방법:**
1. **새로운 엣지 생성률 감소 감지**: 일정 시간 동안 새 엣지가 거의 생성되지 않으면 완료
2. **노드 완료 비율 확인**: 대부분의 노드가 완료되었으면 완료
3. **동치 노드 비율 확인**: 새로 생성되는 노드의 대부분이 동치 노드이면 완료

**완료 조건 조합:**
```python
완료 조건 = (
    엣지 수 >= MAX_EDGE_COUNT OR
    (새 엣지 생성률 < 임계값 AND 지속 시간 > 임계값) OR
    (완료된 노드 비율 > 80%) OR
    (동치 노드 생성 비율 > 90% AND 지속 시간 > 임계값)
)
```

**장점:**
- 실제 탐색 완료 시점 감지
- 최대 엣지 수에 도달하지 않아도 조기 완료 가능
- 리소스 효율적

**단점:**
- 복잡한 로직
- 임계값 튜닝 필요

### 해결책 4: 순환 경로 감지 및 제한

**아이디어:** 같은 노드로 돌아오는 순환 경로를 감지하고 제한

**구현 방법:**
1. 엣지 생성 시 순환 경로 감지 (같은 노드로 돌아오는 경우)
2. 순환 경로가 일정 횟수 이상 발생하면 해당 경로 차단
3. 또는 순환 경로의 깊이를 제한

**장점:**
- 무한 루프 방지
- 불필요한 반복 방지

**단점:**
- 순환 경로 감지 로직 필요
- 일부 유효한 순환 경로도 차단될 수 있음

## 권장 해결책 조합

**1단계: 즉시 구현 가능한 개선**
- 해결책 3: 개선된 완료 조건 체크 (새 엣지 생성률 감소 감지)
- 해결책 4: 순환 경로 감지 및 제한

**2단계: 중기 개선**
- 해결책 2: 노드별 완료 상태 추적
- 해결책 1: 동치 노드 기반 액션 추출 제한

## 구현 우선순위

1. **높은 우선순위**: 새 엣지 생성률 감소 감지 (해결책 3)
   - 구현 난이도: 낮음
   - 효과: 높음
   - 리소스 절약: 높음

2. **중간 우선순위**: 노드별 완료 상태 추적 (해결책 2)
   - 구현 난이도: 중간
   - 효과: 높음
   - 정확도 향상: 높음

3. **낮은 우선순위**: 동치 노드 기반 액션 추출 제한 (해결책 1)
   - 구현 난이도: 높음
   - 효과: 중간
   - 최적화: 높음

## 결론

현재 시스템은 **최대 엣지 수에 도달하기 전에 이미 탐색이 완료되었을 수 있지만 감지하지 못하는 문제**가 있습니다. 또한 **동치 노드에서 반복 탐색**이 발생하여 비효율적입니다.

**즉시 개선 가능한 방법:**
1. 새 엣지 생성률 감소 감지 추가
2. 순환 경로 감지 및 제한 추가

**중기 개선 방법:**
1. 노드별 완료 상태 추적 추가
2. 동치 노드 기반 액션 추출 제한 추가

이러한 개선을 통해 **실제 탐색 완료 시점을 정확히 감지**하고, **불필요한 반복 작업을 방지**할 수 있습니다.
